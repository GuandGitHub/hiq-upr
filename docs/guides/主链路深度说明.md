# 主链路深度说明

## 问题
主链路只生成了3层，而完整树状结构有157层深度，为什么？

## 原因分析

### 1. 完整树 vs 主链路的区别

**完整树（process_tree_skeleton_a588dec8.md）**:
- 展示所有可能的上游路径
- 包含 1989 个 Process 节点
- 最大深度 157 层
- 某些分支非常长（如电力传输链路）

**主链路（main_chain_a588dec8.md）**:
- 每个层级**只选择 exchange value 最大的那条边**
- 只有 3 个节点
- 最大深度 2 层
- 代表的是**最主要的物质/能量来源路径**

### 2. 主链路的实际路径

```
Level 0: 6c59741f → 乙烯,煤基甲醇制（CMTE）,工业级
    ↓ (value = 1.0, flow = 乙烯)
Level 1: 8fdb4514 → 乙烯,煤基甲醇制（CMTE）,工业级
    ↓ (value = 2.69, flow = methanol)
Level 2: baf69ffa → Process-baf69ffa... (叶子节点)
```

### 3. 为什么只有3层？

#### (1) Level 1 自循环
- Level 0 和 Level 1 的 process name 相同，都是 "乙烯,煤基甲醇制（CMTE）,工业级"
- 这代表该工艺的**主要输入就是自身的循环**（value=1.0）

#### (2) Level 2 是叶子节点
- `baf69ffa` 节点在数据库中没有上游输入（没有 is_input=true 且 provider_id 不为空的记录）
- 在完整树中，该节点也是作为**叶子节点**出现的（被其他20个节点引用，但自己没有上游）

#### (3) 最大值路径不等于最长路径
- 主链路算法选择的是 **value 最大** 的边
- `methanol` (value=2.69) 确实是 `8fdb4514` 节点的最主要输入
- 但这条路径恰好很短，因为 methanol 节点是叶子

### 4. 完整树中的其他路径

如果查看完整树，可以看到根节点还有很多其他输入：
- 运输链路（卡车、火车、内河船）
- 电力链路（各级电压传输）→ 这些分支非常深
- 柴油精炼链路
- 等等...

这些链路的 exchange value 都小于 1.0 和 2.69，所以没有被主链路算法选中。

## 结论

**主链路只有3层是正常现象**，因为：

1. 主链路算法的目标是找到 **最主要的物质/能量来源**，而不是最长的路径
2. 根据 exchange value，该工艺的主要输入路径确实就是：
   - 自身循环 (value=1.0)
   - methanol (value=2.69)
3. 如果需要查看所有可能的路径和深层依赖，应该参考完整树（157层）

## 建议

如果需要生成更长的主链路，可以考虑以下调整：

1. **修改选择策略**：不仅考虑最大 value，还考虑路径深度
2. **排除自循环**：跳过 process name 相同的节点
3. **选择 Top N**：不只选最大的一条，而是选择 value 前 N 大的边
4. **排除叶子节点**：如果最大值边指向叶子节点，选择次大值边

但需要注意的是，这些修改会偏离 "最主要来源路径" 的初衷。
